# AI Portal æ€§èƒ½ä¼˜åŒ–æŒ‡å—

æœ¬æ–‡æ¡£æä¾› AI Portal é¡¹ç›®çš„æ€§èƒ½ä¼˜åŒ–ç­–ç•¥å’Œæœ€ä½³å®è·µã€‚

## ğŸ“Š ç›®å½•

1. [ç»„ä»¶çº§ä¼˜åŒ–](#ç»„ä»¶çº§ä¼˜åŒ–)
2. [è·¯ç”±å’Œä»£ç åˆ†å‰²](#è·¯ç”±å’Œä»£ç åˆ†å‰²)
3. [å›¾ç‰‡ä¼˜åŒ–](#å›¾ç‰‡ä¼˜åŒ–)
4. [æ•°æ®è·å–ä¼˜åŒ–](#æ•°æ®è·å–ä¼˜åŒ–)
5. [ç¼“å­˜ç­–ç•¥](#ç¼“å­˜ç­–ç•¥)
6. [æ€§èƒ½ç›‘æ§](#æ€§èƒ½ç›‘æ§)

---

## ç»„ä»¶çº§ä¼˜åŒ–

### 1. ä½¿ç”¨ React.memo é˜²æ­¢ä¸å¿…è¦çš„é‡æ¸²æŸ“

```typescript
import { memo } from "react";

// âŒ æœªä¼˜åŒ– - çˆ¶ç»„ä»¶æ›´æ–°ä¼šå¯¼è‡´å­ç»„ä»¶é‡æ¸²æŸ“
export function ListItem({ item }: { item: Item }) {
  return <div>{item.name}</div>;
}

// âœ… ä¼˜åŒ–å - ä»…åœ¨ props å˜åŒ–æ—¶é‡æ¸²æŸ“
export const ListItem = memo(function ListItem({ item }: { item: Item }) {
  return <div>{item.name}</div>;
});

// âœ… è‡ªå®šä¹‰æ¯”è¾ƒå‡½æ•°
export const ListItem = memo(
  function ListItem({ item }: { item: Item }) {
    return <div>{item.name}</div>;
  },
  (prevProps, nextProps) => {
    // è¿”å› true è¡¨ç¤ºä¸éœ€è¦é‡æ¸²æŸ“
    return prevProps.item.id === nextProps.item.id;
  }
);
```

### 2. ä½¿ç”¨ useMemo ç¼“å­˜è®¡ç®—ç»“æœ

```typescript
import { useMemo } from "react";

function OrdersList({ orders }: { orders: Order[] }) {
  // âŒ æ¯æ¬¡æ¸²æŸ“éƒ½ä¼šé‡æ–°è®¡ç®—
  const totalAmount = orders.reduce((sum, order) => sum + order.amount, 0);

  // âœ… ä»…åœ¨ orders å˜åŒ–æ—¶é‡æ–°è®¡ç®—
  const totalAmount = useMemo(
    () => orders.reduce((sum, order) => sum + order.amount, 0),
    [orders]
  );

  // âœ… å¤æ‚ç­›é€‰é€»è¾‘ç¼“å­˜
  const filteredOrders = useMemo(
    () => orders.filter((order) => order.status === "completed"),
    [orders]
  );

  return (
    <div>
      <p>æ€»é‡‘é¢: Â¥{totalAmount}</p>
      <OrderList items={filteredOrders} />
    </div>
  );
}
```

### 3. ä½¿ç”¨ useCallback ç¼“å­˜å›è°ƒå‡½æ•°

```typescript
import { useCallback } from "react";

function ParentComponent() {
  // âŒ æ¯æ¬¡æ¸²æŸ“éƒ½åˆ›å»ºæ–°å‡½æ•°ï¼Œå¯¼è‡´å­ç»„ä»¶é‡æ¸²æŸ“
  const handleClick = (id: string) => {
    console.log("Clicked:", id);
  };

  // âœ… ç¼“å­˜å‡½æ•°å¼•ç”¨
  const handleClick = useCallback((id: string) => {
    console.log("Clicked:", id);
  }, []); // ä¾èµ–ä¸ºç©ºï¼Œå‡½æ•°æ°¸è¿œä¸å˜

  // âœ… å¸¦ä¾èµ–çš„å›è°ƒ
  const [filter, setFilter] = useState("");
  const handleSearch = useCallback(
    (searchTerm: string) => {
      console.log("Searching:", searchTerm, "with filter:", filter);
    },
    [filter] // ä»…åœ¨ filter å˜åŒ–æ—¶é‡æ–°åˆ›å»ºå‡½æ•°
  );

  return <ChildComponent onClick={handleClick} onSearch={handleSearch} />;
}
```

### 4. è™šæ‹ŸåŒ–é•¿åˆ—è¡¨

```typescript
import { useVirtualizer } from "@tanstack/react-virtual";
import { useRef } from "react";

function VirtualizedList({ items }: { items: Item[] }) {
  const parentRef = useRef<HTMLDivElement>(null);

  const virtualizer = useVirtualizer({
    count: items.length,
    getScrollElement: () => parentRef.current,
    estimateSize: () => 50, // æ¯é¡¹ä¼°è®¡é«˜åº¦
    overscan: 5, // é¢„æ¸²æŸ“ 5 ä¸ªé¡¹ç›®
  });

  return (
    <div ref={parentRef} className="h-[500px] overflow-auto">
      <div
        style={{
          height: `${virtualizer.getTotalSize()}px`,
          width: "100%",
          position: "relative",
        }}
      >
        {virtualizer.getVirtualItems().map((virtualItem) => (
          <div
            key={virtualItem.key}
            style={{
              position: "absolute",
              top: 0,
              left: 0,
              width: "100%",
              height: `${virtualItem.size}px`,
              transform: `translateY(${virtualItem.start}px)`,
            }}
          >
            <ListItem item={items[virtualItem.index]} />
          </div>
        ))}
      </div>
    </div>
  );
}
```

---

## è·¯ç”±å’Œä»£ç åˆ†å‰²

### 1. åŠ¨æ€å¯¼å…¥ (Dynamic Import)

```typescript
import dynamic from "next/dynamic";

// âŒ é™æ€å¯¼å…¥ - æ‰€æœ‰ä»£ç åœ¨é¦–æ¬¡åŠ è½½æ—¶ä¸‹è½½
import HeavyChart from "@/components/heavy-chart";
import BigModal from "@/components/big-modal";

// âœ… åŠ¨æ€å¯¼å…¥ - æŒ‰éœ€åŠ è½½
const HeavyChart = dynamic(() => import("@/components/heavy-chart"), {
  loading: () => <Skeleton className="h-80 w-full" />,
  ssr: false, // ä»…å®¢æˆ·ç«¯æ¸²æŸ“ï¼ˆå¦‚æœç»„ä»¶ä¾èµ–æµè§ˆå™¨ APIï¼‰
});

const BigModal = dynamic(() => import("@/components/big-modal"), {
  loading: () => <div>Loading...</div>,
});

function Dashboard() {
  const [showModal, setShowModal] = useState(false);

  return (
    <div>
      <HeavyChart data={data} />
      {showModal && <BigModal onClose={() => setShowModal(false)} />}
    </div>
  );
}
```

### 2. è·¯ç”±çº§ä»£ç åˆ†å‰²

Next.js è‡ªåŠ¨ä¸ºæ¯ä¸ªé¡µé¢è¿›è¡Œä»£ç åˆ†å‰²ï¼Œä½†è¦æ³¨æ„ï¼š

```typescript
// âœ… æ¯ä¸ªé¡µé¢è‡ªåŠ¨åˆ†å‰²
// app/(pages)/orders/page.tsx
// app/(pages)/users/page.tsx
// app/(pages)/settings/page.tsx

// âŒ é¿å…åœ¨å¸ƒå±€ä¸­å¯¼å…¥å¤§å‹ç»„ä»¶
// app/layout.tsx
import HugeLibrary from "huge-library"; // è¿™ä¼šè¢«æ‰€æœ‰é¡µé¢åŠ è½½

// âœ… åœ¨éœ€è¦çš„é¡µé¢ä¸­å¯¼å…¥
// app/(pages)/orders/page.tsx
import SpecificLibrary from "specific-library";
```

### 3. åˆ†ç»„è·¯ç”± (Route Groups)

```
app/
â”œâ”€â”€ (marketing)/         # è¥é”€é¡µé¢ï¼ˆè½»é‡ï¼‰
â”‚   â”œâ”€â”€ page.tsx
â”‚   â””â”€â”€ about/page.tsx
â”œâ”€â”€ (dashboard)/         # ç®¡ç†åå°ï¼ˆé‡é‡ï¼‰
â”‚   â”œâ”€â”€ orders/page.tsx
â”‚   â””â”€â”€ users/page.tsx
â””â”€â”€ layout.tsx
```

---

## å›¾ç‰‡ä¼˜åŒ–

### 1. ä½¿ç”¨ Next.js Image ç»„ä»¶

```typescript
import Image from "next/image";

// âŒ åŸç”Ÿ img æ ‡ç­¾ - æ— ä¼˜åŒ–
<img src="/hero.jpg" alt="Hero" width="1200" height="600" />

// âœ… Next.js Image ç»„ä»¶ - è‡ªåŠ¨ä¼˜åŒ–
<Image
  src="/hero.jpg"
  alt="Hero"
  width={1200}
  height={600}
  priority  // ä¼˜å…ˆåŠ è½½ï¼ˆLCP å›¾ç‰‡ï¼‰
  placeholder="blur"  // æ¨¡ç³Šå ä½ç¬¦
  blurDataURL="data:image/..."  // è‡ªå®šä¹‰æ¨¡ç³Šå›¾
  quality={85}  // å›¾ç‰‡è´¨é‡ (é»˜è®¤ 75)
  sizes="(max-width: 768px) 100vw, 50vw"  // å“åº”å¼å°ºå¯¸
/>

// âœ… æ‡’åŠ è½½å›¾ç‰‡ï¼ˆé»˜è®¤è¡Œä¸ºï¼‰
<Image
  src="/gallery-1.jpg"
  alt="Gallery"
  width={400}
  height={300}
  loading="lazy"  // é»˜è®¤å°±æ˜¯ lazy
/>
```

### 2. å›¾ç‰‡æ ¼å¼é€‰æ‹©

```typescript
// âœ… ç°ä»£æ ¼å¼ä¼˜å…ˆ
// 1. WebP (æ›´å°ã€è´¨é‡å¥½)
// 2. AVIF (æœ€å°ã€ä½†æµè§ˆå™¨æ”¯æŒæœ‰é™)
// 3. JPEG/PNG (å…¼å®¹æ€§æœ€å¥½)

// Next.js Image ä¼šè‡ªåŠ¨æ ¹æ®æµè§ˆå™¨æ”¯æŒé€‰æ‹©æœ€ä¼˜æ ¼å¼
<Image
  src="/photo.jpg"
  alt="Photo"
  width={800}
  height={600}
  formats={["image/avif", "image/webp"]}
/>
```

### 3. å›¾æ ‡ä¼˜åŒ–

```typescript
// âŒ ä½¿ç”¨å›¾ç‰‡å›¾æ ‡
<img src="/icons/user.png" alt="User" />

// âœ… ä½¿ç”¨ SVG å›¾æ ‡
import { User } from "lucide-react";
<User className="w-4 h-4" />

// âœ… æˆ–ä½¿ç”¨ Sprite Sheet
<svg>
  <use href="/icons-sprite.svg#user" />
</svg>
```

---

## æ•°æ®è·å–ä¼˜åŒ–

### 1. Server Components æ•°æ®é¢„å–

```typescript
// âœ… Server Component - æœåŠ¡ç«¯æ•°æ®è·å–
export default async function OrdersPage() {
  // ç›´æ¥åœ¨æœåŠ¡ç«¯è·å–æ•°æ®
  const orders = await getOrders();

  return <OrdersList orders={orders} />;
}

// âœ… å¹¶è¡Œæ•°æ®è·å–
export default async function DashboardPage() {
  // å¹¶è¡Œæ‰§è¡Œå¤šä¸ªè¯·æ±‚
  const [orders, users, stats] = await Promise.all([
    getOrders(),
    getUsers(),
    getStats(),
  ]);

  return (
    <div>
      <Stats data={stats} />
      <OrdersList orders={orders} />
      <UsersList users={users} />
    </div>
  );
}
```

### 2. ä½¿ç”¨ SWR è¿›è¡Œå®¢æˆ·ç«¯æ•°æ®è·å–

```typescript
import useSWR from "swr";

// âœ… SWR è‡ªåŠ¨å¤„ç†ç¼“å­˜ã€é‡æ–°éªŒè¯ã€é”™è¯¯é‡è¯•
function OrdersList() {
  const { data, error, isLoading } = useSWR("/api/orders", fetcher, {
    revalidateOnFocus: false, // çª—å£èšç„¦æ—¶ä¸é‡æ–°éªŒè¯
    dedupingInterval: 60000, // 60ç§’å†…ç›¸åŒè¯·æ±‚å»é‡
    revalidateOnMount: true, // ç»„ä»¶æŒ‚è½½æ—¶é‡æ–°éªŒè¯
  });

  if (isLoading) return <OrdersPageSkeleton />;
  if (error) return <ErrorState error={error} />;

  return <DataTable data={data} />;
}

// âœ… é¢„åŠ è½½æ•°æ®
function OrderLink({ orderId }: { orderId: string }) {
  const { data } = useSWRPreload(`/api/orders/${orderId}`, fetcher);

  return (
    <Link
      href={`/orders/${orderId}`}
      onMouseEnter={() => {
        // é¼ æ ‡æ‚¬åœæ—¶é¢„åŠ è½½
        mutate(`/api/orders/${orderId}`);
      }}
    >
      View Order
    </Link>
  );
}
```

### 3. åˆ†é¡µå’Œæ— é™æ»šåŠ¨

```typescript
import useSWRInfinite from "swr/infinite";

// âœ… æ— é™æ»šåŠ¨
function InfiniteOrdersList() {
  const { data, error, size, setSize, isLoading } = useSWRInfinite(
    (index) => `/api/orders?page=${index + 1}&limit=20`,
    fetcher
  );

  const orders = data ? data.flat() : [];
  const isLoadingMore = isLoading || (size > 0 && data && !data[size - 1]);
  const isEmpty = data?.[0]?.length === 0;
  const isReachingEnd = isEmpty || (data && data[data.length - 1]?.length < 20);

  return (
    <div>
      {orders.map((order) => (
        <OrderCard key={order.id} order={order} />
      ))}

      {!isReachingEnd && (
        <Button
          onClick={() => setSize(size + 1)}
          disabled={isLoadingMore}
        >
          {isLoadingMore ? "åŠ è½½ä¸­..." : "åŠ è½½æ›´å¤š"}
        </Button>
      )}
    </div>
  );
}
```

---

## ç¼“å­˜ç­–ç•¥

### 1. Next.js ç¼“å­˜é…ç½®

```typescript
// app/api/orders/route.ts
export async function GET() {
  const orders = await getOrders();

  return Response.json(orders, {
    headers: {
      // æµè§ˆå™¨ç¼“å­˜ 5 åˆ†é’Ÿï¼ŒCDN ç¼“å­˜ 1 å°æ—¶
      "Cache-Control": "public, s-maxage=3600, max-age=300",
    },
  });
}

// æˆ–ä½¿ç”¨ Next.js fetch é…ç½®
const data = await fetch("https://api.example.com/data", {
  next: {
    revalidate: 60, // ISR: æ¯ 60 ç§’é‡æ–°éªŒè¯
  },
});

// æ°¸ä¸ç¼“å­˜ï¼ˆå®æ—¶æ•°æ®ï¼‰
const data = await fetch("https://api.example.com/realtime", {
  cache: "no-store",
});
```

### 2. æœ¬åœ°å­˜å‚¨ç¼“å­˜

```typescript
// lib/cache.ts
export class LocalCache {
  private static cache = new Map<string, { data: any; expiry: number }>();

  static set(key: string, data: any, ttl: number = 60000) {
    this.cache.set(key, {
      data,
      expiry: Date.now() + ttl,
    });
  }

  static get(key: string): any | null {
    const item = this.cache.get(key);
    if (!item) return null;

    if (Date.now() > item.expiry) {
      this.cache.delete(key);
      return null;
    }

    return item.data;
  }

  static clear() {
    this.cache.clear();
  }
}

// ä½¿ç”¨ç¤ºä¾‹
async function getOrders() {
  const cached = LocalCache.get("orders");
  if (cached) return cached;

  const orders = await fetchOrders();
  LocalCache.set("orders", orders, 60000); // ç¼“å­˜ 1 åˆ†é’Ÿ
  return orders;
}
```

### 3. React Query / SWR ç¼“å­˜

```typescript
// SWR å…¨å±€é…ç½®
import { SWRConfig } from "swr";

export function Providers({ children }: { children: React.ReactNode }) {
  return (
    <SWRConfig
      value={{
        refreshInterval: 0, // ç¦ç”¨è‡ªåŠ¨åˆ·æ–°
        dedupingInterval: 2000, // 2ç§’å†…ç›¸åŒè¯·æ±‚å»é‡
        revalidateOnFocus: false,
        revalidateOnReconnect: true,
        shouldRetryOnError: true,
        errorRetryCount: 3,
        errorRetryInterval: 5000,
        fetcher: (url: string) => fetch(url).then((res) => res.json()),
      }}
    >
      {children}
    </SWRConfig>
  );
}
```

---

## æ€§èƒ½ç›‘æ§

### 1. Web Vitals ç›‘æ§

```typescript
// app/layout.tsx
import { Analytics } from "@vercel/analytics/react";
import { SpeedInsights } from "@vercel/speed-insights/next";

export default function RootLayout({ children }: { children: React.ReactNode }) {
  return (
    <html lang="zh-CN">
      <body>
        {children}
        <Analytics />
        <SpeedInsights />
      </body>
    </html>
  );
}

// lib/analytics.ts - è‡ªå®šä¹‰ Web Vitals ä¸ŠæŠ¥
export function reportWebVitals(metric: any) {
  if (metric.label === "web-vital") {
    console.log(metric); // å‘é€åˆ°åˆ†ææœåŠ¡

    // ä¸ŠæŠ¥åˆ° Google Analytics
    window.gtag?.("event", metric.name, {
      value: Math.round(metric.name === "CLS" ? metric.value * 1000 : metric.value),
      event_category: "Web Vitals",
      event_label: metric.id,
      non_interaction: true,
    });
  }
}
```

### 2. æ€§èƒ½é¢„ç®—

åœ¨ `next.config.js` ä¸­è®¾ç½®æ€§èƒ½é¢„ç®—ï¼š

```javascript
module.exports = {
  experimental: {
    optimizeCss: true,
    optimizePackageImports: ["lucide-react", "date-fns"],
  },

  // é™åˆ¶é¡µé¢å¤§å°
  onDemandEntries: {
    maxInactiveAge: 25 * 1000,
    pagesBufferLength: 2,
  },

  // ç”Ÿäº§ç¯å¢ƒä¼˜åŒ–
  productionBrowserSourceMaps: false,
  compress: true,
};
```

### 3. React DevTools Profiler

```typescript
import { Profiler } from "react";

function onRenderCallback(
  id: string,
  phase: "mount" | "update",
  actualDuration: number,
  baseDuration: number,
  startTime: number,
  commitTime: number
) {
  console.log(`${id} ${phase}:`, {
    actualDuration, // æœ¬æ¬¡æ¸²æŸ“è€—æ—¶
    baseDuration, // ä¼°è®¡æ¸²æŸ“è€—æ—¶
  });
}

export default function App() {
  return (
    <Profiler id="OrdersList" onRender={onRenderCallback}>
      <OrdersList />
    </Profiler>
  );
}
```

---

## ğŸ¯ æ€§èƒ½æ£€æŸ¥æ¸…å•

### é¦–å±åŠ è½½ä¼˜åŒ–

- [ ] ä½¿ç”¨ Server Components é¢„æ¸²æŸ“å…³é”®å†…å®¹
- [ ] é¦–å±å…³é”®å›¾ç‰‡ä½¿ç”¨ `priority` å±æ€§
- [ ] ç§»é™¤æœªä½¿ç”¨çš„ CSS å’Œ JavaScript
- [ ] å¯ç”¨ Gzip/Brotli å‹ç¼©
- [ ] ä½¿ç”¨ CDN åŠ é€Ÿé™æ€èµ„æº
- [ ] é¢„åŠ è½½å…³é”®å­—ä½“

### è¿è¡Œæ—¶æ€§èƒ½

- [ ] é•¿åˆ—è¡¨ä½¿ç”¨è™šæ‹ŸåŒ–
- [ ] ä½¿ç”¨ `React.memo` ä¼˜åŒ–ç»„ä»¶
- [ ] é¿å…åœ¨æ¸²æŸ“ä¸­è¿›è¡Œæ˜‚è´µçš„è®¡ç®—
- [ ] é˜²æŠ–/èŠ‚æµé¢‘ç¹è§¦å‘çš„äº‹ä»¶
- [ ] æ‡’åŠ è½½éå…³é”®ç»„ä»¶
- [ ] ä½¿ç”¨éª¨æ¶å±æå‡æ„ŸçŸ¥æ€§èƒ½

### ç½‘ç»œä¼˜åŒ–

- [ ] å¯ç”¨ HTTP/2 æˆ– HTTP/3
- [ ] ä½¿ç”¨ SWR æˆ– React Query ç¼“å­˜æ•°æ®
- [ ] å®ç° API è¯·æ±‚å»é‡
- [ ] è®¾ç½®åˆç†çš„ç¼“å­˜ç­–ç•¥
- [ ] ä½¿ç”¨ WebSocket æ›¿ä»£è½®è¯¢ï¼ˆå®æ—¶æ•°æ®ï¼‰

### å›¾ç‰‡ä¼˜åŒ–

- [ ] æ‰€æœ‰å›¾ç‰‡ä½¿ç”¨ Next.js Image ç»„ä»¶
- [ ] å¯ç”¨ WebP/AVIF æ ¼å¼
- [ ] å›¾ç‰‡æ‡’åŠ è½½
- [ ] è®¾ç½®æ­£ç¡®çš„å›¾ç‰‡å°ºå¯¸
- [ ] ä½¿ç”¨ SVG æ›¿ä»£ç®€å•å›¾æ ‡

---

## ğŸ“Š æ€§èƒ½ç›®æ ‡

| æŒ‡æ ‡ | ç›®æ ‡å€¼ | è¯´æ˜ |
|------|--------|------|
| **LCP** (Largest Contentful Paint) | < 2.5s | æœ€å¤§å†…å®¹ç»˜åˆ¶æ—¶é—´ |
| **FID** (First Input Delay) | < 100ms | é¦–æ¬¡è¾“å…¥å»¶è¿Ÿ |
| **CLS** (Cumulative Layout Shift) | < 0.1 | ç´¯ç§¯å¸ƒå±€åç§» |
| **FCP** (First Contentful Paint) | < 1.8s | é¦–æ¬¡å†…å®¹ç»˜åˆ¶ |
| **TTI** (Time to Interactive) | < 3.8s | å¯äº¤äº’æ—¶é—´ |
| **Bundle Size** | < 200KB (gzip) | JavaScript åŒ…å¤§å° |

---

## ğŸ”§ æ€§èƒ½åˆ†æå·¥å…·

1. **Chrome DevTools**
   - Performance é¢æ¿
   - Lighthouse å®¡è®¡
   - Network é¢æ¿
   - Coverage é¢æ¿ï¼ˆæŸ¥æ‰¾æœªä½¿ç”¨ä»£ç ï¼‰

2. **åœ¨çº¿å·¥å…·**
   - [PageSpeed Insights](https://pagespeed.web.dev/)
   - [WebPageTest](https://www.webpagetest.org/)
   - [GTmetrix](https://gtmetrix.com/)

3. **å‘½ä»¤è¡Œå·¥å…·**
   ```bash
   # åˆ†æ Bundle å¤§å°
   npm run build
   npx @next/bundle-analyzer

   # Lighthouse CI
   npx lighthouse https://your-site.com --view
   ```

---

## ğŸ’¡ å»¶ä¼¸é˜…è¯»

- [Next.js Performance Documentation](https://nextjs.org/docs/app/building-your-application/optimizing)
- [web.dev - Web Vitals](https://web.dev/vitals/)
- [React Performance Optimization](https://react.dev/learn/render-and-commit)
- [Image Optimization Best Practices](https://web.dev/fast/#optimize-your-images)
