# OIDC 数据库设计

## 1. 模型概览

我们需要两个主要模型：
1.  **OidcClient**: 用于结构化存储客户端配置，方便在后台管理界面进行 CRUD 操作。
2.  **OidcPayload**: 通用存储表，配合 `oidc-provider` 的 Adapter 使用，存储各类令牌（Session, AccessToken, AuthorizationCode, RefreshToken 等）。

## 2. Prisma Schema 定义

```prisma
// OIDC 客户端配置表
model OidcClient {
  id            String   @id @default(cuid())
  clientId      String   @unique
  clientSecret  String?  // 对于 public client 可为空
  clientName    String?
  clientUri     String?
  logoUri       String?
  
  // 核心配置 (JSON 存储数组或复杂对象)
  redirectUris  String   // JSON string: ["https://app.com/cb"]
  grantTypes    String   // JSON string: ["authorization_code", "refresh_token"]
  responseTypes String   // JSON string: ["code"]
  scope         String   @default("openid profile email")
  
  // 策略配置
  tokenEndpointAuthMethod String @default("client_secret_basic")
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// OIDC 运行时数据存储 (Adapter Pattern)
model OidcPayload {
  id         String   @id // 这里的 ID 通常是 key (e.g., auth code)
  type       String   // 模型类型: Session, AccessToken, RefreshToken, AuthorizationCode, etc.
  payload    String   // JSON 序列化的数据
  grantId    String?  // 关联的 Grant ID
  userCode   String?  // Device Flow user code
  uid        String?  // 内部关联的唯一标识
  expiresAt  DateTime? // 过期时间
  consumedAt DateTime? // 何时被消费 (用于重放检测)

  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  @@index([type])
  @@index([grantId])
  @@index([expiresAt])
}
```

## 3. 映射说明
- `oidc-provider` 的 Adapter 接口包含 `upsert`, `find`, `consume`, `destroy` 等方法。
- 我们将编写一个 `PrismaAdapter` 类来实现这些接口，操作 `OidcPayload` 表。
- `OidcClient` 表的数据将通过 `findClient` 钩子注入到 `oidc-provider` 中。
