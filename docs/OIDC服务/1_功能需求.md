# OIDC 服务功能需求

## 1. 目标
构建一个符合 OIDC Core 1.0 规范的身份认证提供商 (Identity Provider, IdP)，使“AI 门户”能够作为统一认证中心（SSO），为其他内部或第三方应用（Client）提供身份验证和授权服务。

## 2. 核心功能

### 2.1 客户端管理 (Client Management)
- **注册**: 支持动态注册 (Dynamic Registration) 和后台手动注册。
- **管理**: 管理员可创建、查看、编辑、删除客户端。
- **配置项**:
    - Client ID & Client Secret
    - Redirect URIs (回调地址)
    - Grant Types (授权模式：authorization_code, implicit, refresh_token, client_credentials)
    - Response Types (code, id_token, token)
    - Scopes (允许的权限范围)

### 2.2 认证与授权流程
- **Discovery**: 提供 `/.well-known/openid-configuration` 端点。
- **Authorization Endpoint**: 处理 `/oidc/auth` 请求。
    - 支持 `prompt=none|login|consent`。
    - 集成现有的用户登录系统。
- **Token Endpoint**: 处理 `/oidc/token` 请求 (Code Exchange, Refresh Token)。
- **UserInfo Endpoint**: 提供 `/oidc/me` 用户信息。
- **Introspection**: 令牌内省 (RFC 7662)。
- **Revocation**: 令牌撤销 (RFC 7009)。

### 2.3 交互流程 (Interaction)
- **登录**: 复用现有的 NextAuth/Credentials 登录逻辑。
- **授权/同意 (Consent)**: 当客户端请求特定 Scope 时，展示用户同意页面（如：是否允许应用A访问您的个人信息）。

### 2.4 密钥与安全
- **JWKS**: 自动轮换和管理签名密钥。
- **PKCE**: 强制或支持 Proof Key for Code Exchange。

## 3. 技术架构
- **核心库**: `node-oidc-provider` (v8)
- **适配器**: 自定义 Prisma Adapter，用于存储 Session, Code, Token 等。
- **路由**: Next.js App Router API Route (`app/api/oidc/[...oidc]/route.ts`)。
