# 开发流程规范

## 1. 核心工作流 (SOP)
所有功能开发必须严格遵循以下步骤，每个阶段设有**强制卡点**：

### 阶段一：需求分析 (Analysis)
1.  **动作**：澄清模糊点，识别核心业务实体。
2.  **产出**：需求文档。
3.  **🔴 卡点**：**用户确认需求文档**。

### 阶段二：方案与设计 (Design)
1.  **动作**：
    *   **原型设计**：
        - **低保真**：在设计文档中绘制关键页面布局草图（ASCII/线框图）。
        - **高保真 (Hi-fi)**：采用“**代码即原型 (Code as Prototype)**”模式，直接编写 Mock UI 代码。
    *   **数据建模**：定义数据库 Schema。
2.  **产出**：设计文档、原型草图、可交互的 Mock UI 页面。
3.  **🔴 卡点**：**用户确认设计方案与可交互原型**。

### 阶段三：编码实现 (Implementation)
1.  **动作**：
    *   **业务逻辑接入**：基于已确认的 Mock UI，将假数据替换为真实的 API/Server Actions。
    *   **状态处理**：实现 Loading、空状态、错误反馈等交互逻辑。
2.  **产出**：提交的代码 (Commits)。
3.  **自我检查**：运行 `pnpm build` 确保无 TypeScript 报错。

### 阶段四：验证与交付 (Verification)
1.  **动作**：对照“验收标准 (AC)”逐项测试。
2.  **🔴 卡点**：**用户验收通过**。
3.  **收尾**：同步更新相关文档。

## 2. 分支管理 (Branch Management)
*虽然主要在主干开发，但保持逻辑上的分支隔离意识：*
- **Main**: 主分支，保持随时可发布状态。
- **Feat**: 新功能开发（如 `feat/user-management`）。
- **Fix**: Bug 修复（如 `fix/login-issue`）。

## 3. Next.js 16+ 开发规范
- **异步参数 (Async Params)**：
    - 在 Page, Layout, Route Handlers 中，`params` 和 `searchParams` **必须**视为 `Promise`。
    - 严禁直接访问属性，必须使用 `await` 解构。
    - *示例*：`const { id } = await params;`
- **数据获取 (Data Fetching)**：
    - 优先在 **Server Component** 中获取数据。
    - 通过 props 将数据传递给 Client Component。

## 3. 状态管理规范 (URL as State)
- **原则**：列表页的筛选、搜索、分页状态必须同步到 URL 查询参数 (Query Params)。
- **实现**：
    - **读**：Server Component 通过 `searchParams` 读取状态并查询数据库。
    - **写**：Client Component 使用 `router.push` 或 `<Link>` 更新 URL，触发重新渲染。
- **禁止**：仅使用 `useState` 管理会导致刷新丢失的页面级状态。

## 4. Server Action 规范
- **位置**：所有数据变更操作必须存放在 `app/actions/` 目录下。
- **结构**：
    ```typescript
    export async function myAction(data: Schema) {
      try {
        // 1. 验证权限
        // 2. 验证数据
        // 3. 数据库操作
        // 4. 重验证路径
        revalidatePath("/path");
        return { success: true };
      } catch (error) {
        return { success: false, error: "错误信息" };
      }
    }
    ```
- **反馈**：前端必须处理 Action 返回的结果，使用 `sonner` 显示成功或失败提示。

## 5. 代码质量与构建
- **类型安全**：
    - 严禁使用 `any`（除非处理极其复杂的第三方库）。
    - 引入新库时，必须安装对应的 `@types/` 包。
- **构建检查**：提交代码或完成任务前，**必须**运行 `pnpm build` 确保无类型错误。
